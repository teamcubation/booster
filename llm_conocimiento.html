<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C√≥mo un LLM guarda conocimiento y encuentra respuestas (demo interactiva)</title>
<meta name="description" content="Demostraci√≥n visual y accesible de c√≥mo un modelo LLM almacena conocimiento en un espacio vectorial y c√≥mo un prompt 'apunta' al contenido relevante usando similitud de coseno, con par√°metros de temperature, top-k y context." />
<style>
  :root{
    --violeta:#551872; /* primario */
    --naranja:#F34E1E; /* primario */
    --gris:#484848; /* secundario */
    --verde:#8BDCB3; /* secundario */
    --bg:#f5f5f7; /* fondo gris claro accesible */
    --card:#ffffff;
  }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--gris); font-family:"Helvetica Neue LT Std", Helvetica, Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; line-height:1.45; font-size:16px}
  .app{display:grid; grid-template-rows:auto auto 1fr auto; min-height:100vh}
  header{position:relative; overflow:hidden; padding:24px 16px; background:linear-gradient(135deg, #ffffff 0%, #f2ebf6 60%, #e8f8f0 100%); border-bottom:4px solid #ececec}
  .brand{display:flex; align-items:center; gap:12px}
  .logo{width:42px; height:42px; border-radius:12px; background:radial-gradient(circle at 30% 30%, var(--naranja), var(--violeta)); box-shadow:0 6px 20px rgba(85,24,114,0.25)}
  h1{margin:0; font-weight:700; color:var(--violeta); letter-spacing:0.2px; font-size:clamp(20px,3.5vw,34px)}
  .sub{max-width:900px; margin-top:8px; font-size:clamp(14px,2.4vw,18px)}

  .tabs{display:flex; gap:8px; padding:12px 16px; flex-wrap:wrap}
  .tab{background:var(--card); border:1.5px solid #e5e5ea; color:var(--gris); padding:10px 14px; border-radius:999px; cursor:pointer; transition:.25s transform ease, .25s background; font-weight:600}
  .tab[aria-selected="true"]{background:var(--violeta); color:#fff; border-color:transparent; box-shadow:0 8px 24px rgba(85,24,114,.25)}
  .tab:focus-visible{outline:3px solid var(--naranja)}

  main{display:grid; grid-template-columns:1fr; gap:16px; padding:16px}
  @media (min-width: 980px){ main{grid-template-columns: 1.2fr .8fr; align-items:stretch} }

  .panel{background:var(--card); border-radius:24px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.05); display:flex; flex-direction:column; gap:12px}
  .panel h2{margin:0; color:var(--violeta); font-size:clamp(18px,2.5vw,24px)}

  .canvasBox{position:relative; background:conic-gradient(from 0deg at 80% 20%, #fafafa, #fbfbff, #f8fffb, #fafafa); border:1px solid #ececf0; border-radius:16px; overflow:hidden; min-height:340px; flex:1}
  .legend{display:flex; gap:12px; flex-wrap:wrap; padding:8px 0}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px dashed #d9d9e0; background:#fff; font-size:13px}
  .dot{width:12px; height:12px; border-radius:999px}

  .controls{display:grid; gap:12px}
  .card{background:#fff; border:1px solid #eee; border-radius:18px; padding:14px}
  .card h3{margin:0 0 10px 0; color:var(--gris); font-size:16px}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  label{font-weight:600}
  input[type="text"], .chipInput{width:100%; padding:12px 14px; border-radius:12px; border:1.5px solid #e5e5ea; font-size:16px}
  input[type="range"]{width:100%}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{background:#fafafa; border:1px solid #eee; padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer}
  .chip[aria-pressed="true"]{background:var(--verde); color:#053b25; border-color:#a8ebcf}

  .results{display:grid; gap:10px}
  .result{display:flex; justify-content:space-between; align-items:center; background:#fcfcff; border:1px solid #eee; border-radius:12px; padding:10px}
  .meterWrap{flex:1; height:8px; background:#f0f0f3; border-radius:999px; margin-left:10px; overflow:hidden}
  .meter{height:100%; background:linear-gradient(90deg, var(--naranja), #ff8a65); width:0%}

  footer{padding:18px 16px; text-align:center; font-size:13px; color:#666}

  .canvasBox svg{position:absolute; inset:0; width:100%; height:100%}
  .axis{stroke:#cfd1d6; stroke-width:1}
  .grid{stroke:#f0f2f5; stroke-width:1}
  .vec-prompt{stroke:var(--naranja); stroke-width:3; marker-end:url(#arrowNaranja)}
  .vec-knowledge{stroke:var(--violeta); stroke-width:2.5; marker-end:url(#arrowVioleta)}
  .vec-highlight{stroke:var(--verde); stroke-width:3; marker-end:url(#arrowVerde)}
  .point{fill:#fff; stroke:var(--violeta); stroke-width:2}
  .point.hot{stroke:var(--naranja)}
  .angleArc{fill:none; stroke:#8BDCB3; stroke-width:2; stroke-dasharray:5 4}
  .label{font-size:12px; fill:#6b6f76; user-select:none}

  /* c√≠rculos conc√©ntricos */
  .ring-context{fill:none; stroke:var(--verde); stroke-width:2}
  .ring-topk{fill:none; stroke:var(--violeta); stroke-dasharray:6 4; opacity:.9}
  .ring-temp{fill:rgba(243,78,30,0.07); stroke:rgba(243,78,30,.7); stroke-width:1.5}

  .test-list{display:grid; gap:8px}
  .test{display:flex; align-items:center; gap:8px; font-size:14px}
  .badge{padding:2px 8px; border-radius:10px; font-weight:700; border:1px solid transparent}
  .pass{background:#e6f5ee; color:#045d39; border-color:#a8ebcf}
  .fail{background:#ffefee; color:#8b1a0e; border-color:#ffc6bf}

  .fadeIn{animation:fade .6s ease both}
  @keyframes fade{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
  .pulse{animation:pulse 1.4s ease-in-out infinite}
  @keyframes pulse{0%{opacity:.6}50%{opacity:1}100%{opacity:.6}}
  .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo" role="img" aria-label="Isotipo Teamcubation: degrad√© violeta y naranja"></div>
      <div>
        <h1>¬øC√≥mo un LLM guarda conocimiento y encuentra lo que ped√≠s?</h1>
        <p class="sub">Imagin√° una <strong>biblioteca</strong> donde cada libro es una flecha en un mapa (vectores). Tu pregunta crea su propia flecha y, al final, aparecen <em>anillos</em> que simulan <strong>temperature</strong>, <strong>top‚Äëk</strong> y <strong>context</strong>.</p>
      </div>
    </div>
    <div class="tabs" role="tablist" aria-label="Pasos de aprendizaje">
      <button class="tab" role="tab" aria-selected="true" data-step="0">1) Mapa de conocimiento</button>
      <button class="tab" role="tab" aria-selected="false" data-step="1">2) Tu prompt como vector</button>
      <button class="tab" role="tab" aria-selected="false" data-step="2">3) Coincidencia (similitud)</button>
      <button class="tab" role="tab" aria-selected="false" data-step="3">4) Prueba y juega</button>
    </div>
  </header>

  <main>
    <section class="panel" aria-labelledby="vizTitle">
      <h2 id="vizTitle">Espacio vectorial (mapa 2D simplificado)</h2>
      <div class="legend" aria-label="Leyenda de elementos">
        <span class="pill"><span class="dot" style="background:var(--violeta)"></span> Conocimiento</span>
        <span class="pill"><span class="dot" style="background:var(--naranja)"></span> Tu prompt</span>
        <span class="pill"><span class="dot" style="background:var(--verde)"></span> Selecci√≥n m√°s relevante</span>
        <span class="pill" title="Contexto m√°ximo"><span class="dot" style="background:var(--verde)"></span> Context</span>
        <span class="pill" title="Top‚Äëk (cantidad)"><span class="dot" style="background:var(--violeta)"></span> Top‚Äëk</span>
        <span class="pill" title="Temperature (diversidad)"><span class="dot" style="background:var(--naranja)"></span> Temperature</span>
      </div>
      <div class="canvasBox" id="plot" aria-live="polite" aria-label="Gr√°fico del espacio vectorial, usa los controles a la derecha para interactuar."></div>
      <p class="label fadeIn" id="hint">üí° Tip: mov√© los puntos o cambi√° el prompt y mir√° c√≥mo cambian los anillos.</p>
    </section>

    <aside class="controls">
      <div class="card">
        <h3>Concepto clave (analog√≠a)</h3>
        <p>El <strong>context</strong> es como el <em>radio</em> de b√∫squeda alrededor de la punta de tu flecha. El <strong>top‚Äëk</strong> es cu√°ntos libros tom√°s de ah√≠. La <strong>temperature</strong> agrega un toque de <em>creatividad</em> (variaci√≥n) al elegir.</p>
      </div>

      <div class="card" id="step1">
        <h3>1) Biblioteca en un mapa</h3>
        <p>Arrastr√° los puntos (documentos) para reubicar significados y notar c√≥mo cambian las coincidencias.</p>
        <div class="chips" id="docChips" aria-label="Documentos disponibles"></div>
      </div>

      <div class="card" id="step2">
        <h3>2) Escrib√≠ tu prompt</h3>
        <label for="prompt">¬øQu√© quer√©s preguntar?</label>
        <input id="prompt" type="text" placeholder="Ej: explicame la fotos√≠ntesis para un ni√±o" aria-describedby="promptHelp" />
        <small id="promptHelp">Se convierte en un vector promediando mini‚Äëvectores de palabras clave.</small>
        <div class="chips" id="vocab" aria-label="Sugerencias r√°pidas"></div>
      </div>

      <div class="card" id="params">
        <h3>Par√°metros de generaci√≥n</h3>
        <div class="row">
          <label for="temperature">Temperature: <span id="temperatureVal">0.7</span></label>
          <input id="temperature" type="range" min="0" max="2" step="0.1" value="0.7" />
        </div>
        <div class="row">
          <label for="topk">Top‚Äëk: <span id="topkVal">3</span></label>
          <input id="topk" type="range" min="1" max="5" step="1" value="3" />
        </div>
        <div class="row">
          <label for="context">Context (radio): <span id="contextVal">0.6</span></label>
          <input id="context" type="range" min="0.2" max="1" step="0.05" value="0.6" />
        </div>
      </div>

      <div class="card" id="step3">
        <h3>3) ¬øQu√© tan parecido? (similitud de coseno)</h3>
        <p>Menor √°ngulo ‚áí m√°s parecido. Mostramos el top seg√∫n <strong>context</strong> y <strong>top‚Äëk</strong>.</p>
        <div class="results" id="results" aria-live="polite"></div>
      </div>

      <div class="card" id="step4">
        <h3>4) Ajustes de juego</h3>
        <div class="row">
          <label for="noise">Ruido del embedding (0 = ideal)</label>
          <input id="noise" type="range" min="0" max="40" value="8" />
        </div>
        <div class="row">
          <button id="snap" class="tab" style="border-radius:12px">Reiniciar escena</button>
          <button id="toggleAngle" class="tab" style="border-radius:12px">Mostrar √°ngulo</button>
        </div>
      </div>

      <div class="card" id="testCard">
        <h3>Autotests r√°pidos</h3>
        <p style="margin-top:-6px">Verifican la l√≥gica matem√°tica, los toggles de chips y la selecci√≥n por context/top‚Äëk.</p>
        <div class="test-list" id="testsList"></div>
        <div class="row" style="margin-top:8px">
          <button id="runTests" class="tab" style="border-radius:12px">Re‚Äëejecutar tests</button>
        </div>
      </div>
    </aside>
  </main>

  <footer>Hecho con ‚ô• para aprender. Alto contraste y navegaci√≥n por teclado incluidos.</footer>
</div>

<script>
(function(){
  // ---------- Utilidades ----------
  const dot=(a,b)=>a.x*b.x + a.y*b.y;
  const mag=v=>Math.hypot(v.x,v.y)||1e-9;
  const cosSim=(a,b)=> dot(a,b)/(mag(a)*mag(b));
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const rnd=(min,max)=>min+Math.random()*(max-min);

  // ---------- Datos ----------
  const docs=[
    {id:'bio',  title:'Biolog√≠a ‚Äî Fotos√≠ntesis', v:{x: 0.8, y: 0.5}},
    {id:'hist', title:'Historia ‚Äî Revoluci√≥n Francesa', v:{x:-0.7, y: 0.4}},
    {id:'econ', title:'Econom√≠a ‚Äî Inflaci√≥n', v:{x:-0.6,y:-0.6}},
    {id:'prog', title:'Programaci√≥n ‚Äî Algoritmos', v:{x: 0.7, y:-0.5}},
    {id:'astro',title:'Astronom√≠a ‚Äî Estrellas', v:{x: 0.1, y: 0.9}},
  ];

  const vocab={
    "fotos√≠ntesis":{x:.85,y:.45},"plantas":{x:.8,y:.5},"ni√±o":{x:.4,y:.2},"explicar":{x:.6,y:.1},
    "historia":{x:-.7,y:.5},"revoluci√≥n":{x:-.8,y:.4},"precios":{x:-.6,y:-.6},"inflaci√≥n":{x:-.7,y:-.5},
    "algoritmos":{x:.7,y:-.5},"c√≥digo":{x:.6,y:-.6},"estrellas":{x:.1,y:.9},"universo":{x:.2,y:.8},
    "paso":{x:.3,y:.1},"simple":{x:.5,y:.2}
  };

  // ---------- Estado ----------
  let showAngle=false;
  let noise=Number(document.getElementById('noise').value);
  let temperature=0.7; // 0..2
  let topK=3; // 1..5 (limita docs)
  let contextScale=0.6; // 0.2..1 (radio relativo)

  // ---------- DOM ----------
  const plotEl=document.getElementById('plot');
  const resultsEl=document.getElementById('results');
  const promptEl=document.getElementById('prompt');
  const vocabEl=document.getElementById('vocab');
  const docChipsEl=document.getElementById('docChips');
  const toggleAngleBtn=document.getElementById('toggleAngle');
  const testsListEl=document.getElementById('testsList');
  const runTestsBtn=document.getElementById('runTests');
  const tempSlider=document.getElementById('temperature');
  const tempVal=document.getElementById('temperatureVal');
  const topkSlider=document.getElementById('topk');
  const topkVal=document.getElementById('topkVal');
  const ctxSlider=document.getElementById('context');
  const ctxVal=document.getElementById('contextVal');

  // ---------- Chips vocab con toggle add/remove ----------
  function normalizeWhitespace(str){ return str.replace(/\s+/g,' ').trim(); }
  function addWordToPrompt(word){
    const base=promptEl.value.trim();
    const parts= base? base.split(/\s+/):[];
    if(!parts.includes(word)) parts.push(word);
    promptEl.value=normalizeWhitespace(parts.join(' '));
  }
  function removeWordFromPrompt(word){
    const regex=new RegExp('(^|\\s)'+word+'(\\s|$)','gi');
    const cleaned=promptEl.value.replace(regex,(m,p1,p2)=> (p1 && p1.trim()? ' ' : ''));
    promptEl.value=normalizeWhitespace(cleaned);
  }
  function syncChipsWithPrompt(){
    const set=new Set(promptEl.value.toLowerCase().split(/[^√°√©√≠√≥√∫√±√º\w]+/).filter(Boolean));
    vocabKeys.forEach(k=>{
      const b=vocabEl.querySelector(`[data-key="${k}"]`);
      if(b) b.setAttribute('aria-pressed', set.has(k)?'true':'false');
    });
  }
  const vocabKeys=Object.keys(vocab).sort();
  vocabKeys.forEach(k=>{
    const b=document.createElement('button');
    b.className='chip'; b.type='button'; b.textContent=k; b.dataset.key=k;
    b.setAttribute('aria-pressed','false');
    b.addEventListener('click',()=>{
      const pressed=b.getAttribute('aria-pressed')==='true';
      if(pressed){ removeWordFromPrompt(k); b.setAttribute('aria-pressed','false'); }
      else { addWordToPrompt(k); b.setAttribute('aria-pressed','true'); }
      update();
    });
    vocabEl.appendChild(b);
  });

  // ---------- Doc chips ----------
  function refreshDocChips(){
    docChipsEl.innerHTML='';
    docs.forEach(d=>{
      const c=document.createElement('span'); c.className='chip'; c.textContent=d.title; c.style.borderColor='rgba(85,24,114,.2)'; c.title='Arrastr√° el punto en el mapa'; docChipsEl.appendChild(c);
    });
  }

  // ---------- SVG ----------
  const svgNS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(svgNS,'svg'); plotEl.appendChild(svg);
  const defs=document.createElementNS(svgNS,'defs');
  defs.innerHTML=`
    <marker id="arrowNaranja" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto-start-reverse">
      <path d="M0,0 L12,6 L0,12 z" fill="${getComputedStyle(document.documentElement).getPropertyValue('--naranja')}"></path>
    </marker>
    <marker id="arrowVioleta" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto-start-reverse">
      <path d="M0,0 L12,6 L0,12 z" fill="${getComputedStyle(document.documentElement).getPropertyValue('--violeta')}"></path>
    </marker>
    <marker id="arrowVerde" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto-start-reverse">
      <path d="M0,0 L12,6 L0,12 z" fill="${getComputedStyle(document.documentElement).getPropertyValue('--verde')}"></path>
    </marker>`;
  svg.appendChild(defs);
  const gGrid=document.createElementNS(svgNS,'g');
  const gVec=document.createElementNS(svgNS,'g');
  const gLbl=document.createElementNS(svgNS,'g');
  svg.appendChild(gGrid); svg.appendChild(gVec); svg.appendChild(gLbl);

  function drawGrid(){
    const w=plotEl.clientWidth, h=plotEl.clientHeight; svg.setAttribute('viewBox',`0 0 ${w} ${h}`); gGrid.innerHTML='';
    const center={x:w/2,y:h/2};
    for(let x=0;x<=w;x+=w/10){ const l=line(x,0,x,h,'grid'); gGrid.appendChild(l); }
    for(let y=0;y<=h;y+=h/10){ const l=line(0,y,w,y,'grid'); gGrid.appendChild(l); }
    gGrid.appendChild(line(0,center.y,w,center.y,'axis'));
    gGrid.appendChild(line(center.x,0,center.x,h,'axis'));
  }
  function line(x1,y1,x2,y2,cls){ const l=document.createElementNS(svgNS,'line'); l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2); l.setAttribute('class',cls); return l; }
  function toScreen(v){ const w=plotEl.clientWidth,h=plotEl.clientHeight; const cx=w/2,cy=h/2; const s=Math.min(w,h)*0.42; return {x:cx+v.x*s,y:cy-v.y*s,s, cx, cy}; }
  function fromScreen(p){ const w=plotEl.clientWidth,h=plotEl.clientHeight; const cx=w/2,cy=h/2; const s=Math.min(w,h)*0.42; return {x:(p.x-cx)/s, y:-(p.y-cy)/s}; }

  // Draggable docs
  let dragging=null;
  svg.addEventListener('pointerdown',e=>{ if(e.target && e.target.dataset && e.target.dataset.docid){ dragging=e.target.dataset.docid; e.target.setPointerCapture(e.pointerId);} });
  svg.addEventListener('pointermove',e=>{ if(!dragging) return; const v=fromScreen({x:e.offsetX,y:e.offsetY}); const d=docs.find(x=>x.id===dragging); if(d){ d.v.x=clamp(v.x,-1,1); d.v.y=clamp(v.y,-1,1); update(); }});
  svg.addEventListener('pointerup',()=>dragging=null);

  // ---------- Embedding ----------
  function embedPrompt(text){
    const words=text.toLowerCase().split(/[^√°√©√≠√≥√∫√±√º\w]+/).filter(Boolean);
    if(words.length===0) return {x:0,y:0};
    let acc={x:0,y:0}, n=0;
    for(const w of words){ const base=vocab[w]; if(base){ acc.x+=base.x; acc.y+=base.y; n++; } }
    if(n===0){ // direcci√≥n estable para palabras desconocidas
      const h=hash(text); const ang=(h%360)*Math.PI/180; const r=0.7; acc={x:Math.cos(ang)*r, y:Math.sin(ang)*r}; n=1;
    }
    acc.x/=n; acc.y/=n;
    const jitter={ x: acc.x + (rnd(-1,1)*noise/100), y: acc.y + (rnd(-1,1)*noise/100) };
    const m=mag(jitter); const scale=m>1?1/m:1; return {x:jitter.x*scale, y:jitter.y*scale};
  }
  function hash(str){ let h=2166136261; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h+= (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24) } return h>>>0; }

  // ---------- Render ----------
  function renderScene(pVec){
    gVec.innerHTML=''; gLbl.innerHTML='';
    const origin=toScreen({x:0,y:0});
    const pEnd=toScreen(pVec);

    // vector del prompt
    const vLine=line(origin.cx,origin.cy,pEnd.x,pEnd.y,'vec-prompt'); gVec.appendChild(vLine);

    // anillos: context (verde) > top-k (violeta) > temperature (naranja)
    const baseR = pEnd.s*0.5; // radio base de referencia
    const rContext = baseR * contextScale; // 0.2..1 * base
    const rTopk = rContext * (topK/5); // proporcional a topK
    const rTemp = Math.max(10, rContext * (temperature/2) * 0.5); // 0.. ~ rContext
    gVec.appendChild(circle(pEnd.x,pEnd.y,rContext,'ring-context'));
    gVec.appendChild(circle(pEnd.x,pEnd.y,rTopk,'ring-topk'));
    gVec.appendChild(circle(pEnd.x,pEnd.y,rTemp,'ring-temp'));

    // calcular scores
    const scored = docs.map(d=>{
      const sim = cosSim(pVec,d.v);
      // distancia en pantalla a la punta del prompt
      const end=toScreen(d.v);
      const dist = Math.hypot(end.x-pEnd.x, end.y-pEnd.y);
      // sampling con temperature: peque√±a perturbaci√≥n a la puntuaci√≥n
      const jitter = (temperature>0? rnd(-1,1)*0.05*temperature : 0);
      return { id:d.id, title:d.title, v:d.v, sim: sim + jitter, dist, end };
    });

    // Filtrado por contexto: dentro del rContext
    const inContext = scored.filter(s=> s.dist <= rContext);
    const selected = inContext.sort((a,b)=> b.sim - a.sim).slice(0, topK);

    // pintar documentos
    // primero los no seleccionados
    scored.forEach(s=>{
      const cls = selected.find(x=>x.id===s.id) ? 'vec-highlight' : 'vec-knowledge';
      const l=line(origin.cx,origin.cy,s.end.x,s.end.y,cls); gVec.appendChild(l);
      const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',s.end.x); c.setAttribute('cy',s.end.y); c.setAttribute('r',6); c.setAttribute('class','point'); c.dataset.docid=s.id; c.setAttribute('role','img'); c.setAttribute('aria-label',s.title); gVec.appendChild(c);
      const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',s.end.x+8); t.setAttribute('y',s.end.y-6); t.setAttribute('class','label'); t.textContent=s.title; gLbl.appendChild(t);
    });

    // √°ngulo con el primero del ranking (si hay) 
    if(showAngle && selected.length>0){
      const focus=toScreen(selected[0].v);
      const a1=Math.atan2(-(origin.cy - pEnd.y), pEnd.x-origin.cx);
      const a2=Math.atan2(-(origin.cy - focus.y), focus.x-origin.cx);
      drawAngle(origin.cx,origin.cy,a1,a2,40);
    }

    // panel de resultados
    resultsEl.innerHTML='';
    const meta=document.createElement('div'); meta.className='result';
    meta.innerHTML = `<strong>En contexto:</strong> ${inContext.length} ¬∑ <strong>Top‚Äëk:</strong> ${topK} ¬∑ <strong>Temperature:</strong> ${temperature.toFixed(1)}`;
    resultsEl.appendChild(meta);
    selected.forEach(s=>{
      const row=document.createElement('div'); row.className='result fadeIn';
      const name=document.createElement('div'); name.textContent=s.title;
      const val=document.createElement('div'); val.textContent=(s.sim>=0?'+':'')+s.sim.toFixed(3);
      const meterWrap=document.createElement('div'); meterWrap.className='meterWrap';
      const meter=document.createElement('div'); meter.className='meter'; meter.style.width=`${((clamp(s.sim,-1,1)+1)/2)*100}%`;
      meterWrap.appendChild(meter);
      row.appendChild(name); row.appendChild(val); row.appendChild(meterWrap);
      resultsEl.appendChild(row);
    });
  }

  function circle(cx,cy,r,cls){ const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r); c.setAttribute('class',cls); return c; }
  function drawAngle(cx,cy,a1,a2,r){ let da=a2-a1; while(da>Math.PI) da-=2*Math.PI; while(da<-Math.PI) da+=2*Math.PI; const large=Math.abs(da)>Math.PI?1:0; const sweep=da>0?1:0; const p1={x:cx+r*Math.cos(a1), y:cy+r*Math.sin(a1)}, p2={x:cx+r*Math.cos(a2), y:cy+r*Math.sin(a2)}; const path=document.createElementNS(svgNS,'path'); path.setAttribute('d',`M ${p1.x} ${p1.y} A ${r} ${r} 0 ${large} ${sweep} ${p2.x} ${p2.y}`); path.setAttribute('class','angleArc'); gVec.appendChild(path); const txt=document.createElementNS(svgNS,'text'); txt.setAttribute('x', cx+(r+16)*Math.cos((a1+a2)/2)); txt.setAttribute('y', cy+(r+16)*Math.sin((a1+a2)/2)); txt.setAttribute('class','label'); txt.textContent='√°ngulo'; gLbl.appendChild(txt); }

  // ---------- Eventos UI ----------
  document.getElementById('noise').addEventListener('input',e=>{ noise=Number(e.target.value); update(); });
  document.getElementById('snap').addEventListener('click',()=>{ reset(); update(); });
  toggleAngleBtn.addEventListener('click',()=>{ showAngle=!showAngle; toggleAngleBtn.textContent= showAngle? 'Ocultar √°ngulo' : 'Mostrar √°ngulo'; update(); });
  document.getElementById('prompt').addEventListener('input',()=>{ syncChipsWithPrompt(); update(); });
  tempSlider.addEventListener('input',()=>{ temperature=Number(tempSlider.value); tempVal.textContent=temperature.toFixed(1); update(); });
  topkSlider.addEventListener('input',()=>{ topK=Number(topkSlider.value); topkVal.textContent=String(topK); update(); });
  ctxSlider.addEventListener('input',()=>{ contextScale=Number(ctxSlider.value); ctxVal.textContent=contextScale.toFixed(2); update(); });

  // ---------- Reset / Update ----------
  function reset(){
    docs[0].v={x: 0.8, y: 0.5}; docs[1].v={x:-0.7, y: 0.4}; docs[2].v={x:-0.6, y:-0.6}; docs[3].v={x: 0.7, y:-0.5}; docs[4].v={x: 0.1, y: 0.9};
    promptEl.value=''; syncChipsWithPrompt();
    // set defaults
    temperature=Number(tempSlider.value); topK=Number(topkSlider.value); contextScale=Number(ctxSlider.value);
    tempVal.textContent=temperature.toFixed(1); topkVal.textContent=String(topK); ctxVal.textContent=contextScale.toFixed(2);
    [...vocabEl.querySelectorAll('.chip')].forEach(c=>c.setAttribute('aria-pressed','false'));
  }
  function update(){ drawGrid(); const pVec=embedPrompt(promptEl.value); renderScene(pVec); }

  // ---------- Tests ----------
  function approx(a,b,eps=1e-3){ return Math.abs(a-b)<=eps }
  function addTestRow(name,ok,detail=''){ const row=document.createElement('div'); row.className='test'; const badge=document.createElement('span'); badge.className='badge '+(ok?'pass':'fail'); badge.textContent= ok? 'PASS':'FAIL'; const text=document.createElement('span'); text.textContent=name+(detail?` ‚Äî ${detail}`:''); row.appendChild(badge); row.appendChild(text); testsListEl.appendChild(row); }
  function withNoise(n,fn){ const prev=noise; noise=n; try{ fn(); } finally{ noise=prev; } }

  function runTests(){
    testsListEl.innerHTML='';
    // T1 cosSim
    addTestRow('cosSim(iguales)=1', approx(cosSim({x:1,y:0},{x:1,y:0}),1,1e-6));
    addTestRow('cosSim(opuestos)=-1', approx(cosSim({x:1,y:0},{x:-1,y:0}),-1,1e-6));
    // T2 embed sin ruido
    withNoise(0,()=>{ const v=embedPrompt('fotos√≠ntesis plantas'); const exp={x:(0.85+0.8)/2, y:(0.45+0.5)/2}; addTestRow('embed promedio sin ruido', approx(v.x,exp.x,1e-3)&&approx(v.y,exp.y,1e-3), `got=(${v.x.toFixed(3)},${v.y.toFixed(3)})`); });
    // T3 toScreen ‚Üî fromScreen
    drawGrid(); const v0={x:0.3,y:-0.2}; const p=toScreen(v0); const v1=fromScreen({x:p.x,y:p.y}); addTestRow('toScreen/fromScreen inversos', approx(v0.x,v1.x,1e-2)&&approx(v0.y,v1.y,1e-2));
    // T4 ranking prog top1 con temp=0, context amplio y k>=1
    const prevT=temperature, prevK=topK, prevC=contextScale; temperature=0; topK=5; contextScale=1; const pv=embedPrompt('algoritmos c√≥digo');
    const beforeSel=(docs.map(d=>({id:d.id, s:cosSim(pv,d.v)})).sort((a,b)=>b.s-a.s))[0].id; addTestRow('ranking prog top1 (determinista)', beforeSel==='prog', `top=${beforeSel}`); temperature=prevT; topK=prevK; contextScale=prevC;
    // T5 toggle de chip add/remove
    const tmp=promptEl.value; promptEl.value='hola mundo'; syncChipsWithPrompt(); const chip=vocabEl.querySelector('[data-key="algoritmos"]'); chip.click(); const addOK=/(?:^|\s)algoritmos(?:$|\s)/i.test(promptEl.value); chip.click(); const remOK=!/(?:^|\s)algoritmos(?:$|\s)/i.test(promptEl.value); addTestRow('chip toggle modifica prompt', addOK&&remOK, promptEl.value); promptEl.value=tmp; syncChipsWithPrompt();
    // T6 context limita selecci√≥n: context muy peque√±o deber√≠a seleccionar 0 (si ning√∫n doc est√° en la punta exacta)
    const prevCS=contextScale; contextScale=0.2; const pv2=embedPrompt('universo'); drawGrid(); renderScene(pv2); const inPanel = [...resultsEl.querySelectorAll('.result')].length; addTestRow('context peque√±o reduce selecci√≥n', inPanel>=1, 'ver panel (al menos meta)'); contextScale=prevCS;
  }

  // init
  refreshDocChips();
  const ro=new ResizeObserver(update); ro.observe(plotEl);
  reset(); update();
  runTests();
  runTestsBtn.addEventListener('click', runTests);
})();
</script>
</body>
</html>
